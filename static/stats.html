<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/static/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/static/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/static/favicon-16x16.png"
    />
    <link rel="manifest" href="/static/site.webmanifest" />
    <link
      rel="mask-icon"
      href="/static/safari-pinned-tab.svg"
      color="#6441a5"
    />
    <meta name="msapplication-TileColor" content="#6441a5" />
    <meta name="theme-color" content="#6441a5" />

    <meta property="og:title" content="Watch streamers with no audience" />
    <meta property="og:site_name" content="Nobody.Live" />
    <meta property="og:url" content="https://nobody.live/" />
    <meta
      property="og:description"
      content="Become the entire audience of a lonely streamer broadcasting to zero viewers"
    />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://nobody.live/og.png" />

    <meta name="title" content="Nobody.live Stats" />
    <meta
      name="description"
      content="Nobody.live stream statistics and information"
    />
    <meta
      name="keywords"
      content="stream, no viewers stream, streams with no audience, twitch no viewers"
    />
    <meta name="robots" content="index, follow" />
    <meta name="language" content="English" />
    <meta name="author" content="Jack Kingsman" />

    <link
      rel="stylesheet"
      type="text/css"
      href="/static/datatables/datatables.min.css"
    />
    <style>
      h2,
      p {
        margin: 0px;
      }

      .title {
        display: inline;
      }

      .stat-callouts {
        text-align: center;
        display: inline-block;
        margin-right: 25px;
      }

      .time-label {
        margin-bottom: 10px;
        font-size: smaller;
        font-style: oblique;
      }

      .data-display {
        width: 100%;
        height: 300px;
      }

      .chart-container {
        width: 100%;
        height: 600px;
        max-height: 100vh;
      }
    </style>

    <title>Nobody.live | Stats</title>
  </head>
  <body>
    <h1>Nobody.live Statistics</h1>
    <hr />
    <details open>
      <summary>
        <h2 class="title" id="reload-vitals">Vitals</h2>
      </summary>
        <p class="time-label" id="vitals-fresh-time"></p>
        <div class="stat-callouts">
          <h2 id="zero-viewer-stream-count"></h2>
          <p>zero viewer streams</p>
        </div>
        <div class="stat-callouts">
          <h2 id="one-viewer-stream-count"></h2>
          <p>one viewer streams</p>
        </div>
        <div class="stat-callouts">
          <h2 id="total-stream-count"></h2>
          <p>total streams</p>
        </div>
        <div class="stat-callouts">
          <h2 id="game-count"></h2>
          <p>unique games</p>
        </div>
    </details>
    <hr />
    <details>
      <summary>
        <h2 class="title" id="reload-games">Games</h2>
      </summary>
        <p class="time-label" id="games-fresh-time"></p>
        <table id="games" class="display" style="width:100%">
        </table>
    </details>
    <hr />
    <details>
      <summary>
        <h2 class="title" id="reload-tags">Tags</h2>
      </summary>
        <p class="time-label" id="tags-fresh-time"></p>
        <table id="tags" class="display" style="width:100%">
        </table>
    </details>
    <hr />
    <details>
      <summary>
        <h2 class="title" id="reload-tags">Scan Generations</h2>
      </summary>
      <textarea readonly class="data-display" id="generation-data"></textarea>
    </details>
    <details>
      <summary>
        <h2 class="title" id="reload-tags">DB Size CSV</h2>
      </summary>
      <textarea readonly class="data-display" id="db-data">time,zero_viewer,one_viewer,total_streams
</textarea>
    </details>
    <details open>
      <summary>
        <h2 class="title" id="reload-tags">DB Size Chart</h2>
      </summary>
      <div class="chart-container">
        <canvas id="db-data-chart" width="400" height="400"></canvas>
      </div>
    </details>
    <hr />

    <script type="text/javascript" src="/static/datatables/datatables.min.js"></script>
    <script type="text/javascript" src="/static/chartjs/chart.min.js"></script>
    <script>
      const server = document.location.origin;

      async function load_vitals() {
        const vitals = await fetch(`${server}/stats/counts`);
        const age = new Date(vitals.headers.get("x-cached-since") * 1000);
        const vitals_json = await vitals.json();

        document.getElementById("vitals-fresh-time").innerText = age;
        document.getElementById("zero-viewer-stream-count").innerText = vitals_json.zero_viewer_count;
        document.getElementById("one-viewer-stream-count").innerText = vitals_json.one_viewer_count;
        document.getElementById("total-stream-count").innerText = vitals_json.total_count;
        document.getElementById("game-count").innerText = vitals_json.unique_games;
      }

      load_vitals();
      document.getElementById("reload-vitals").addEventListener("click", load_vitals);

      async function load_games() {
        const games = await fetch(`${server}/stats/games`);
        const age = new Date(games.headers.get("x-cached-since") * 1000);
        const games_json = await games.json();

        columnar_games = []
        for (game in games_json) {
            columnar_games.push([
                game,
                games_json[game].zero_viewer,
                games_json[game].one_viewer,
                games_json[game].total,
            ]);
        }

        document.getElementById("games-fresh-time").innerText = age;
        $('#games').DataTable({
            destroy: true,
            scrollY: '500px',
            scrollCollapse: true,
            paging: false,
            data: columnar_games,
            columns: [
                { title: 'Game' },
                { title: 'Zero Viewer Streams' },
                { title: 'One Viewer Streams' },
                { title: 'Total Streams' },
            ],
        });
      }

      document.getElementById("reload-games").addEventListener("click", load_games);

      async function load_tags() {
        const tags = await fetch(`${server}/stats/tags`);
        const age = new Date(tags.headers.get("x-cached-since") * 1000);
        const tags_json = await tags.json();

        columnar_tags = []
        for (game in tags_json) {
            columnar_tags.push([
                game,
                tags_json[game].zero_viewer,
                tags_json[game].one_viewer,
                tags_json[game].total,
            ]);
        }

        document.getElementById("tags-fresh-time").innerText = age;
        $('#tags').DataTable({
            destroy: true,
            scrollY: '500px',
            scrollCollapse: true,
            paging: false,
            data: columnar_tags,
            columns: [
                { title: 'Tag' },
                { title: 'Zero Viewer Streams' },
                { title: 'One Viewer Streams' },
                { title: 'Total Streams' },
            ],
        });
      }

      document.getElementById("reload-tags").addEventListener("click", load_tags);

      let last_loaded_data_time = new Date();
      let chart_data = {labels: [], data: []};
      let chart_obj;
      async function append_generation_data() {
        const vitals = await fetch(`${server}/stats/counts`);
        const age = new Date(vitals.headers.get("x-cached-since") * 1000);
        const vitals_json = await vitals.json();

        if (age.getTime() == last_loaded_data_time.getTime()) {
          return;
        } else {
          last_loaded_data_time = age;
        }

        const generation_data = document.getElementById('generation-data');
        generation_data.value = `${generation_data.value}${Math.floor(age / 1000)}: ${JSON.stringify(vitals_json.generations)}\n`;
        generation_data.scrollTop = generation_data.scrollHeight;

        const db_data = document.getElementById('db-data');
        db_data.value = `${db_data.value}${Math.floor(age / 1000)},${vitals_json.zero_viewer_count},${vitals_json.one_viewer_count},${vitals_json.total_count}\n`;
        db_data.scrollTop = db_data.scrollHeight;

        chart_data.labels.push(Math.floor(age / 1000));
        chart_data.data.push(vitals_json.total_count);
        const ctx = document.getElementById('db-data-chart');
        const chart_options = {
          type: 'line',
          data: {
            labels: chart_data.labels,
            datasets: [{
              label: 'Stream Count',
              data: chart_data.data,
              fill: true,
              borderColor: 'rgb(75, 192, 192)',
              tension: 0.1
            }]
          },
          options: {
            maintainAspectRatio: false,
          }
        }

        if (!chart_obj) {
          chart_obj = new Chart(ctx, chart_options);
        } else {
          chart_obj.options = chart_options;
          chart_obj.update();
        }
      }
      append_generation_data();
      setInterval(append_generation_data, 6000);
    </script>
  </body>
</html>
