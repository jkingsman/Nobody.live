<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png" />
    <link rel="manifest" href="/static/site.webmanifest" />
    <link rel="mask-icon" href="/static/safari-pinned-tab.svg" color="#6441a5" />
    <meta name="msapplication-TileColor" content="#6441a5" />
    <meta name="theme-color" content="#6441a5" />

    <meta property="og:title" content="Watch streamers with no audience" />
    <meta property="og:site_name" content="Nobody.Live" />
    <meta property="og:url" content="https://nobody.live/" />
    <meta property="og:description" content="Become the entire audience of a lonely streamer broadcasting to zero viewers" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://nobody.live/og.png" />

    <meta name="title" content="Nobody.live Stats" />
    <meta name="description" content="Nobody.live stream statistics and information" />
    <meta name="keywords" content="stream, no viewers stream, streams with no audience, twitch no viewers" />
    <meta name="robots" content="index, follow" />
    <meta name="language" content="English" />
    <meta name="author" content="Jack Kingsman" />

    <link rel="stylesheet" type="text/css" href="/static/datatables/datatables.min.css" />
    <style>
      h2,
      p {
        margin: 0px;
      }

      .title {
        display: inline;
      }

      .stat-callouts {
        text-align: center;
        display: inline-block;
        margin-right: 25px;
      }

      .time-label {
        margin-bottom: 10px;
        font-size: smaller;
        font-style: oblique;
      }

      .data-display {
        width: 100%;
        height: 300px;
      }

      .chart-container {
        width: 100%;
        height: 600px;
        max-height: 100vh;
      }
    </style>

    <title>Nobody.live | Stats</title>
  </head>
  <body>
    <h1>Nobody.live Statistics</h1>
    <hr />
    <details open>
      <summary>
        <h2 class="title" id="reload-vitals">Vitals</h2>
      </summary>
        <p class="time-label" id="vitals-fresh-time"></p>
        <div class="stat-callouts">
          <h2 id="zero-viewer-stream-count"></h2>
          <p>zero viewer streams</p>
        </div>
        <div class="stat-callouts">
          <h2 id="one-viewer-stream-count"></h2>
          <p>one viewer streams</p>
        </div>
        <div class="stat-callouts">
          <h2 id="total-stream-count"></h2>
          <p>total streams</p>
        </div>
        <div class="stat-callouts">
          <h2 id="game-count"></h2>
          <p>unique games</p>
        </div>
    </details>
    <hr />
    <details>
      <summary>
        <h2 class="title" id="reload-games">Games</h2>
      </summary>
        <p class="time-label" id="games-fresh-time"></p>
        <table id="games" class="display" style="width:100%">
        </table>
    </details>
    <hr />
    <details>
      <summary>
        <h2 class="title" id="reload-tags">Tags</h2>
      </summary>
        <p class="time-label" id="tags-fresh-time"></p>
        <table id="tags" class="display" style="width:100%">
        </table>
    </details>
    <hr />
    <details>
      <summary>
        <h2 class="title">Scan Generation Breakdown</h2>
      </summary>
      <input type="checkbox" id="enable-scan-generations" checked>
      <label for="enable-scan-generations"> Enable</label>
      <textarea readonly class="data-display" id="generation-data"></textarea>
    </details>
    <details>
      <summary>
        <h2 class="title">DB Size CSV (live sums)</h2>
      </summary>
      <button id="download-rolling-csv">Download</button>
      <input type="checkbox" id="enable-db-size" checked>
      <label for="enable-db-size"> Enable</label>
      <textarea readonly class="data-display" id="db-data-rolling">time,zero_viewer,one_viewer,total_streams
</textarea>
    </details>
    <details>
      <summary>
        <h2 class="title">DB Size CSV (generation snapshots after complete load)</h2>
      </summary>
      <input type="checkbox" id="enable-db-size-snapshots" checked>
      <label for="enable-db-size-snapshots"> Enable</label>
      <button id="download-snapshot-csv">Download</button>
      <textarea readonly class="data-display" id="db-data-snapshot">time,zero_viewer,one_viewer
</textarea>
    </details>
    <details open>
      <summary>
        <h2 class="title">DB Size Chart</h2>
      </summary>
      <input type="checkbox" id="enable-chart" checked>
      <label for="enable-chart"> Enable</label>
      <div class="chart-container">
        <canvas id="db-data-chart" width="400" height="400"></canvas>
      </div>
    </details>
    <hr />

    <script type="text/javascript" src="/static/datatables/datatables.min.js"></script>
    <script type="text/javascript" src="/static/chartjs/chart.min.js"></script>
    <script>
      /* global Chart */
      /* eslint no-restricted-syntax: "off", guard-for-in: "off" */
      const server = document.location.origin;

      async function loadVitals() {
        const vitals = await fetch(`${server}/stats/counts`);
        const age = new Date(vitals.headers.get('x-cached-since') * 1000);
        const vitalsJSON = await vitals.json();

        document.getElementById('vitals-fresh-time').innerText = age;
        document.getElementById('zero-viewer-stream-count').innerText = vitalsJSON.zero_viewer_count;
        document.getElementById('one-viewer-stream-count').innerText = vitalsJSON.one_viewer_count;
        document.getElementById('total-stream-count').innerText = vitalsJSON.total_count;
        document.getElementById('game-count').innerText = vitalsJSON.unique_games;
      }

      loadVitals();
      document.getElementById('reload-vitals').addEventListener('click', loadVitals);
      document.getElementById('reload-vitals').addEventListener('touchstart', loadVitals);

      async function loadGames() {
        const games = await fetch(`${server}/stats/games`);
        const age = new Date(games.headers.get('x-cached-since') * 1000);
        const gamesJSON = await games.json();

        const columnarGames = [];
        for (const game in gamesJSON) {
          columnarGames.push([
            game,
            gamesJSON[game].zero_viewer,
            gamesJSON[game].one_viewer,
            gamesJSON[game].total,
          ]);
        }

        document.getElementById('games-fresh-time').innerText = age;
        $('#games').DataTable({
          destroy: true,
          scrollY: '500px',
          scrollCollapse: true,
          paging: false,
          data: columnarGames,
          columns: [
            { title: 'Game' },
            { title: 'Zero Viewer Streams' },
            { title: 'One Viewer Streams' },
            { title: 'Total Streams' },
          ],
        });
      }

      document.getElementById('reload-games').addEventListener('click', loadGames);
      document.getElementById('reload-games').addEventListener('touchstart', loadGames);

      async function loadTags() {
        const tags = await fetch(`${server}/stats/tags`);
        const age = new Date(tags.headers.get('x-cached-since') * 1000);
        const tagsJSON = await tags.json();

        const columnarTags = [];
        for (const game in tagsJSON) {
          columnarTags.push([
            game,
            tagsJSON[game].zero_viewer,
            tagsJSON[game].one_viewer,
            tagsJSON[game].total,
          ]);
        }

        document.getElementById('tags-fresh-time').innerText = age;
        $('#tags').DataTable({
          destroy: true,
          scrollY: '500px',
          scrollCollapse: true,
          paging: false,
          data: columnarTags,
          columns: [
            { title: 'Tag' },
            { title: 'Zero Viewer Streams' },
            { title: 'One Viewer Streams' },
            { title: 'Total Streams' },
          ],
        });
      }
      document.getElementById('reload-tags').addEventListener('click', loadTags);
      document.getElementById('reload-tags').addEventListener('touch_start', loadTags);

      function downloadCSV(id) {
        const content = document.getElementById(id).value;
        const downloadableLink = document.createElement('a');
        downloadableLink.setAttribute('href', `data:text/plain;charset=utf-8,${encodeURIComponent(content)}`);
        downloadableLink.download = 'nobody.live_dbData.csv';
        document.body.appendChild(downloadableLink);
        downloadableLink.click();
        document.body.removeChild(downloadableLink);
      }
      document.getElementById('download-rolling-csv').addEventListener('click', () => { downloadCSV('db-data-rolling'); });
      document.getElementById('download-rolling-csv').addEventListener('touchstart', () => { downloadCSV('db-data-rolling'); });
      document.getElementById('download-snapshot-csv').addEventListener('click', () => { downloadCSV('db-data-snapshot'); });
      document.getElementById('download-snapshot-csv').addEventListener('touchstart', () => { downloadCSV('db-data-snapshot'); });

      let lastLoadedDataTime = new Date();
      let lastLoadedSnapshotTime = 0;
      const chartData = { labels: [], data: [] };
      let chartObj;
      async function appendGenerationData() {
        const vitals = await fetch(`${server}/stats/counts`);
        const age = new Date(vitals.headers.get('x-cached-since') * 1000);
        const vitalsJSON = await vitals.json();

        if (age.getTime() === lastLoadedDataTime.getTime()) {
          return;
        }
        lastLoadedDataTime = age;

        if (document.getElementById('enable-scan-generations').checked) {
          const generationData = document.getElementById('generation-data');
          generationData.value = `${generationData.value}${Math.floor(age / 1000)}: ${JSON.stringify(vitalsJSON.generations)}\n`;
          generationData.scrollTop = generationData.scrollHeight;
        }

        if (document.getElementById('enable-db-size').checked) {
          const dbData = document.getElementById('db-data-rolling');
          dbData.value = `${dbData.value}${Math.floor(age / 1000)},${vitalsJSON.zero_viewer_count},${vitalsJSON.one_viewer_count},${vitalsJSON.total_count}\n`;
          dbData.scrollTop = dbData.scrollHeight;
        }

        if (document.getElementById('enable-db-size-snapshots').checked) {
          // a load is only complete once another newer load has started
          if (Object.keys(vitalsJSON.generations).length === 2) {
            const oldestGeneration = Math.min(...Object.keys(vitalsJSON.generations).map(Number));
            if (oldestGeneration !== lastLoadedSnapshotTime) {
              const generationData = vitalsJSON.generations[oldestGeneration];
              lastLoadedSnapshotTime = oldestGeneration;
              const dbDataSnapshot = document.getElementById('db-data-snapshot');
              dbDataSnapshot.value = `${dbDataSnapshot.value}${Math.floor(oldestGeneration)},${generationData.zero_viewer_count},${generationData.one_viewer_count}\n`;
              dbDataSnapshot.scrollTop = dbDataSnapshot.scrollHeight;
            }
          }
        }

        if (document.getElementById('enable-chart').checked) {
          chartData.labels.push(Math.floor(age / 1000));
          chartData.data.push(vitalsJSON.total_count);
          const ctx = document.getElementById('db-data-chart');
          const chartOptions = {
            type: 'line',
            data: {
              labels: chartData.labels,
              datasets: [{
                label: 'Stream Count',
                data: chartData.data,
                fill: true,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1,
              }],
            },
            options: {
              maintainAspectRatio: false,
            },
          };

          if (!chartObj) {
            chartObj = new Chart(ctx, chartOptions);
          } else {
            chartObj.options = chartOptions;
            chartObj.update();
          }
        }
      }
      appendGenerationData();
      setInterval(appendGenerationData, 2000);
    </script>
  </body>
</html>
